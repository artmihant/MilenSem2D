# Part 3: Построение модели в формате fc

## Задача
Построение модели в формате FidesysCase с использованием данных материалов и геометрии сетки. Исследование различных размеров сетки и адаптивных подходов к огрублению.

## Исходные данные

### Загрузка данных
**Файлы:**
- `model1_material.npz` — упругие параметры материалов (Vp, плотность, Vs)
- `model1_mesh_coords.npz` — геометрия сетки с адаптацией к геологии

**Размеры:**
- Материалы: 1175×244×3 (горизонталь × глубина × параметры)
- Сетка: 1176×245 узлов (деформированная по геологическим границам)

## Методы построения моделей

### 1. Построение базовых FC моделей

#### Функция: `build_fc_model_from_arrays()`
**Параметры:**
- X, Z координаты узлов сетки
- Vp, плотность, Vs — массивы свойств материалов
- Путь для сохранения fc файла

**Алгоритм:**
1. Создание узлов сетки (векторизованное)
2. Генерация элементов (QUAD4 для 2D)
3. Расчет упругих модулей и коэффициентов Пуассона
4. Создание материалов с табличными свойствами
5. Формирование блока и сохранение модели

### 2. Огрубление сетки

#### Функция: `create_coarse_grid()`
**Параметры:**
- `dx_target`, `dz_target` — желаемые размеры ячеек (м)
- `kriging_params` — массив свойств [nx×nz×3]
- `x_coords`, `z_coords` — координаты сетки

**Алгоритм:**
- Агрегация по горизонтали до 50м (сохранение геометрии)
- Факторы агрегации: `x_factor = dx_target/dx_orig`
- Усреднение свойств в блоках агрегации

### 3. Адаптивные модели

#### Функция: `build_adaptive_fc_model()`
**Параметры:**
- `threshold_percent` — порог схожести слоев (%)
- `max_merge_layers` — максимум объединяемых слоев
- Геометрия и материалы

#### Алгоритм объединения слоев:
1. Агрегация по горизонтали до 50м
2. Объединение похожих слоев по порогу схожести
3. Сохранение геологической геометрии
4. Построение FC модели

#### Критерий схожести:
```
max_diff = max(|next_val - current_val| / |current_val|) * 100
объединять если: max_diff ≤ threshold_percent
```

## Сравнение моделей

### Базовые модели
| Модель | Размер ячеек | Элементов | Узлов | Файл |
|--------|--------------|-----------|-------|------|
| 10×10 | 10×10 м | 288120 | 288896 | `model1_10x10.fc` |
| 50×10 | 50×10 м | 57624 | 58140 | `model1_50x10.fc` |
| 50×40 | 50×40 м | 14406 | 14541 | `model1_50x40.fc` |

### Адаптивные модели
| Порог | Слоев | Коэффициент сжатия | Элементов | Файл |
|-------|-------|-------------------|-----------|------|
| 1% | 36 | 6.8x | 42180 | `model1_50a1p.fc` |
| 2% | 51 | 4.8x | 56448 | `model1_50a2p.fc` |
| 3% | 64 | 3.8x | 75648 | `model1_50a3p.fc` |
| 4% | 85 | 2.9x | 19975 | `model1_50a4p.fc` |
| 5% | 108 | 2.3x | 125664 | `model1_50a5p.fc` |

## Выбор оптимальной модели

### Рекомендация: `model1_50a4p.fc`
**Характеристики:**
- Оригинальных слоев: 244
- Объединенных слоев: 85
- Коэффициент сжатия: 2.9x
- Элементов: 19975 (235×85)
- Узлов: 20296

**Преимущества:**
- Хорошая степень сжатия (почти в 3 раза)
- Сохранение геологической детальности
- Оптимальный баланс качества и производительности

## Выходные данные

### FC файлы
- `model1_10x10.fc` — эталонная модель
- `model1_50x10.fc` — грубая по горизонтали
- `model1_50x40.fc` — грубая по обоим направлениям
- `model1_50a1p.fc` — `model1_50a5p.fc` — адаптивные модели

### Графические файлы
- `img/image_50x10.png` — визуализация модели 50×10
- `img/image_50x40.png` — визуализация модели 50×40
- `img/image_50a1p.png` — `img/image_50a5p.png` — адаптивные модели

## Использование

### Загрузка данных
```python
import numpy as np

# Загрузка материалов
material_data = np.load('model1_material.npz')
kriging_params = material_data['kriging_params']

# Загрузка геометрии
mesh_data = np.load('model1_mesh_coords.npz')
x_coords = mesh_data['x_coordinates']
z_coords = mesh_data['z_coordinates']
```

### Построение модели
```python
from fc_model import FCModel, FCMaterial, FCBlock

# Создание модели
elements_count, nodes_count = build_fc_model_from_arrays(
    x_coords, z_coords, 
    vp, density, vs, 
    'output_model.fc'
)
```

### Адаптивная модель
```python
elements_count, nodes_count, merge_info = build_adaptive_fc_model(
    kriging_params, x_coords, z_coords,
    threshold_percent=4.0,  # 4%
    max_merge_layers=5,
    output_path='adaptive_model.fc'
)
```

## Управление отображением
```python
SHOW_PLOTS = False  # True - показывать графики, False - только сохранять
```

## Заключение
Успешно созданы модели различных размеров и типов:
- Базовые модели с фиксированным шагом сетки
- Адаптивные модели с объединением похожих слоев
- Выбрана оптимальная модель `model1_50a4p.fc` для дальнейших расчетов. Её дано название: `model1.fc`
