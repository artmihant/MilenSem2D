# Part 4: Построение сплайновой модели с адаптированной сеткой

## Задача
Построение сплайновой модели в формате Fidesys с адаптированной по длине волны сеткой. Создание геометрии, сетки и подготовка к расчету распространения сейсмических волн с использованием спектральных элементов.

## Исходные данные

### Геометрия и материалы
**Файлы:**
- `model1_mesh_coords.npz` — координаты деформированной сетки
- `data/static_material.csv` — статические свойства материалов по слоям

**Параметры сетки:**
- Размер: 1176×245 узлов (деформированная по геологии)
- Длина профиля: 11750 м
- Глубина: до 2440 м
- Слои: 18 геологических слоев

### Статические материалы
**Файл:** `data/static_material.csv`
**Свойства:**
- Vp — скорость P-волн (м/с)
- Vs — скорость S-волн (м/с)
- Плотность (г/см³)
- Максимальный размер ячейки (h_max) для каждого слоя

## Методы построения модели

### 1. Создание сплайновой геометрии

#### Функция: `model3_geom.jou`
**Алгоритм:**
1. Извлечение координат вершин из деформированной сетки (каждую 5-ю точку)
2. Создание вершин в Fidesys: `create vertex location <x> <y> <z>`
3. Построение сплайновых кривых: `create curve spline location vertex [...]`
4. Создание сплайновых поверхностей: `create surface skin curve <c1> <c2>`
5. Оптимизация геометрии (merge, compress)

**Результат:** 18 сплайновых поверхностей, соответствующих геологическим слоям.

### 2. Построение адаптивной сетки

#### Функция: `model3_mesh.jou`
**Параметры сетки:**
- Горизонтальные интервалы: [235, 235, 235, 235, 170, 175, 175, 175, 175, 135, 135, 135, 135, 135, 135, 135, 135, 135]
- Вертикальные интервалы: [4, 3, 4, 6, 4, 2, 3, 5, 8, 1, 1, 1, 1, 1, 1, 1, 1, 1]

**Алгоритм:**
1. Задание количества интервалов на кривых: `curve <id> scheme equal interval <n>`
2. Генерация сетки на кривых: `mesh curve all`
3. Выбор схемы для поверхностей:
   - `scheme map` — для структурированных слоев (равное количество интервалов)
   - `scheme pave` — для неструктурированных слоев (адаптивная сетка)
4. Генерация сетки на поверхностях: `mesh surface all`

**Особенности адаптации:**
- Структурированные слои: слои 1-4 (глубокие, толстые)
- Неструктурированные слои: слои 5-18 (поверхностные, тонкие)
- Адаптация к геологической структуре и длине волны

### 3. Назначение материалов

#### Функция: `model3_material.jou`
**Параметры:**
- Порядок спектрального элемента: SEM_DEG = 3
- 18 материалов (по количеству слоев)

**Алгоритм:**
1. Создание материалов: `create material <id>`
2. Задание свойств: VP, VS, DENSITY
3. Создание блоков: `block <id> add surface <id>`
4. Назначение спектрального порядка: `block <id> material <id> cs 1 category plane order <SEM_DEG>`

## Подготовка к расчету

### Граничные условия
#### Функция: `model3_bc.jou`
**Источник сигнала:**
- Тип: сила на узле
- Положение: центр левой границы (узел INT_1//2)
- Форма: Ricker wavelet
- Параметры: амплитуда TEST_AMP = 1e5, частота TEST_FR = 10 Гц

**Поглощающие границы:**
- Нижняя граница: `create absorption on curve 51`
- Верхняя граница: открытые кривые
- Боковые границы: поглощающие условия

**Приемники:**
- Положение: кривая 1 (левая граница)
- Тип: velocity (скорость)

### Параметры расчета
#### Функция: `model3_calc.jou`
**Тип анализа:**
- Динамический анализ упругости
- 2D плоская деформация
- Без предварительного нагружения

**Метод решения:**
- Полное решение
- Явная схема
- Максимум шагов: 30000
- Максимальное время: 3 секунды
- Шаг вывода результатов: 0.1 секунды

## Выходные данные

### Скрипты Fidesys
- `model3_geom.jou` — создание сплайновой геометрии
- `model3_mesh.jou` — генерация адаптивной сетки
- `model3_material.jou` — назначение материалов
- `model3_bc.jou` — граничные условия
- `model3_calc.jou` — параметры расчета

### Результаты расчета
**Файлы:** `model3/model3_Vx.sgy`, `model3/model3_Vy.sgy`
- Сейсмограммы компонент скорости Vx, Vy
- Формат: SEG-Y
- Шаг по времени: 0.1 секунды

### Визуализация
- `img/model3_geom.png` — геометрия модели

## Использование

### Запуск расчета в Fidesys
```bash
# Последовательное выполнение скриптов
fidesys model3_geom.jou
fidesys model3_mesh.jou  
fidesys model3_material.jou
fidesys model3_bc.jou
fidesys model3_calc.jou
```

### Загрузка и анализ результатов
```python
import numpy as np
from obspy import read

# Загрузка сейсмограмм
st_vx = read('model3/model3_Vx.sgy')
st_vy = read('model3/model3_Vy.sgy')

# Анализ сигнала
print(f"Количество трасс: {len(st_vx)}")
print(f"Длительность: {st_vx[0].stats.endtime - st_vx[0].stats.starttime}")
```

### Параметры адаптации сетки
```python
# Интервалы по горизонтали (адаптированные)
intervals_x = [235, 235, 235, 235, 170, 175, 175, 175, 175, 
               135, 135, 135, 135, 135, 135, 135, 135, 135]

# Интервалы по вертикали (минимальные)
intervals_z = [4, 3, 4, 6, 4, 2, 3, 5, 8, 1, 1, 1, 1, 1, 1, 1, 1, 1]
```

## Особенности модели

### Адаптивность сетки
- **Структурированные слои:** глубокие толщи с равномерной сеткой
- **Неструктурированные слои:** поверхностные слои с адаптивной сеткой
- **Оптимизация:** баланс между точностью и вычислительной эффективностью

### Спектральные элементы
- **Порядок:** 3-й порядок (для тестового расчета снижен до 2)
- **Преимущества:** высокая точность при меньшем числе элементов
- **Применение:** идеально для волновых задач

### Граничные условия
- **Источник:** сосредоточенная сила с импульсом Ricker
- **Поглощение:** на границах для предотвращения отражений
- **Приемники:** на поверхности для регистрации сейсмограмм

## Заключение
Успешно создана сплайновая модель с адаптированной сеткой для расчета распространения сейсмических волн. Модель включает:

- Сплайновую геометрию, точно воспроизводящую геологические границы
- Адаптивную сетку, оптимизированную по длине волны
- Спектральные элементы высокого порядка для точного решения
- Полный набор граничных условий для волнового моделирования

Модель готова для проведения расчетов распространения сейсмических волн и анализа волновых полей в сложной геологической среде.
